(function(e,t){"use strict";"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self,e.myChart=t())})(this,function(){"use strict";function e(e){if(e)return this(e)}var t=function(e){var t={title:{show:!1,name:"",fontStyle:{weight:"bold",size:"20px",family:"Arial",color:"#000",align:"left"}},grid:{top:60,right:"10%",left:"10%",bottom:60},x:{name:"",nameStyle:{color:"#000",size:"12px",family:"Arial",weight:"bold"},type:"category",data:[],fontStyle:{color:"#000",size:"12px",family:"Arial"},lineStyle:{color:"#000",width:1}},y:{name:"",nameStyle:{color:"#000",size:"12px",family:"Arial",weight:"bold"},data:[],fontStyle:{color:"#000",size:"12px",family:"Arial",weight:"normal"},lineStyle:{color:"#000",width:1},splitLineStyle:{color:"#c1c1c1",width:1}},series:{type:"line",lineStyle:{color:"#0032ff",width:1},markLine:{data:[],lineStyle:{color:"#ebd662",width:1},fontStyle:{color:"#ebd662",size:"12px",family:"Microsoft YaHei",weight:"normal"}},dataMsg:{oneFreq:0,rotateSpeed:0,specType:1,spectral:0,setPower:!1},symbol:{show:!1,color:"",size:3}},toolTip:{symbol:{show:!0,color:"",size:3},lineStyle:{color:"#FA9A4D",width:1},fontStyle:{color:"#fff",size:"12px",family:"Microsoft YaHei",weight:"normal"},background:{color:"rgba(50, 50, 50, 0.3)"},formatter:function(e){}},tools:{enlarge:{show:!1,dom:null},maxOrMin:{show:!1,dom:null},restore:{show:!1,dom:null,formatter:e=>{}},timeDifferent:{show:!1,dom:null},subFreq:{show:!1,dom:null},oneFreq:{show:!1,dom:null,formatter:e=>{}},labelFreq:{show:!1,dom:null},peakSearch:{show:!1,dom:null},addLabel:{show:!1,dom:null},cancelLabel:{show:!1,dom:null},setPeak:{show:!1,dom:null},exportImage:{show:!1,dom:null,imageName:"",formatter:function(e){return e}},exportData:{fileName:"",show:!1,dom:null},exportAudio:{fileName:"",show:!1,dom:null,maxFreq:null}},backgroundColor:"rgba(255, 255, 255, 0)",changePos:!1},o=function(e){if(e)return this._dom={name:e,id:null,width:0,height:0},this._computeParams={extremum:{},proportion:{}},this._flag={spectrumXName:"",spectrumYName:"",dataLength:0,zoom:0,click:1,line:{key:-1,val:-1},last_xWave:{key:-1,val:-1},labelLine:{spectrum:[],wave:[]},maxMin:0,addPeak:[],addPeakPos:[],dragLabel:!1,peakIndexArr:[],arr_B:[],arr_C:[],toolCheck:-1,tools:{flag_subFreq:0,flag_oneF:0,flag_nx:0,autoPeakNum:-1,flag_addPeak:!1,flag_subTime:0,flag_wave_extend:0}},this._scope={v:{x:{start:null,end:null,length:null},y:{start:null,end:null,length:null}},r:{r:null,w:null,b:null,h:null}},this._movePos={x:{oldVal:0,newVal:0,move:0,source:0,addLabel:0},y:{oldVal:0,newVal:0,move:0,source:0,addLabel:0}},this._option=null,this._drawTools={canvas:{},ctx:{}},this.event={dom:{click:e=>{if(e.stopPropagation(),!this._flag.zoom&&this._option&&this._option.x.data.length>0&&!this._flag.dragLabel){var t=e.offsetX,o=e.offsetY;let i;if(!(t>=this._option.grid.left&&t<=this._scope.r.r))return;if(i=this.findNearbyPoint(t),this._flag.tools.flag_addPeak&&(i.key=this.fft_indexOfWaveX(i.val,this._option.y.data[i.key],1),i.val=this._option.x.data[i.key]),!(t>=this._option.grid.left&&t<=this._scope.r.r&&o>=this._option.grid.top&&o<=this._scope.r.b))return;this._flag.line={val:i.val,key:i.key},this._flag.click&&t>=this._option.grid.left&&t<=this._scope.r.r&&o>=this._option.grid.top&&o<=this._scope.r.b&&(this._option.tools.timeDifferent.show&&this._option.tools.timeDifferent.dom&&this.labelLineWave(),(this._option.tools.subFreq.show&&this._option.tools.subFreq.dom||this._option.tools.labelFreq.show&&this._option.tools.labelFreq.dom||this._option.tools.oneFreq.show&&this._option.tools.oneFreq.dom||this._option.tools.peakSearch.show&&this._option.tools.peakSearch.dom)&&this.labelLineSpec(),this._flag.tools.flag_subTime||this._flag.tools.flag_subFreq||this._flag.tools.flag_nx?this.drawLabelLine():(this._flag.toolCheck=0,this.drawLine(this._flag.line))),this._option.toolTip.formatter(this._flag.line)}},dragWave:e=>{e.stopPropagation();let t=0;if(this._option&&this._option.x.data.length>0&&"CANVAS"===e.target.nodeName){let o=this._movePos.x,i=this._movePos.y,l=this._scope,a=l.r,s=l.v,n=this._computeParams.proportion,r=n.x,h=n.y,d=this._computeParams.extremum.x;if(o.newVal=e.offsetX,o.move=o.newVal-o.oldVal,i.newVal=e.offsetY,i.move=i.newVal-i.oldVal,i.source>=a.b&&i.source<=a.b+30){if(t=Math.abs((o.newVal-r.b)/r.k-(o.oldVal-r.b)/r.k),0===o.move)return;o.move>0?s.x.start-t<d.min?(s.x.start=d.min,s.x.end-=s.x.start-d.min):(s.x.start-=t,s.x.end-=t,o.oldVal=e.offsetX):s.x.end+t>d.max?(s.x.end=d.max,s.x.start+=d.max-s.x.end):(s.x.start+=t,s.x.end+=t,o.oldVal=e.offsetX);let i={min:Number.MAX_VALUE,max:Number.MIN_VALUE};i.start=this.findNearbyPoint(this._option.grid.left).key,i.end=this.findNearbyPoint(a.r).key+1,i.data=this._option.y.data.slice(i.start,i.end);for(let e=0,t=i.data.length;e<t;e++)i.min>i.data[e]&&(i.min=i.data[e]),i.max<i.data[e]&&(i.max=i.data[e]);s.y.start=i.min,s.y.end=1.1*i.max,this._flag.click=1,this.mappingX(2),this.mappingY(2),this.drawAxis(),this.drawWave(),this.zoomLine()}else if(o.source<this._option.grid.left){if(t=Math.abs((i.newVal-h.b)/h.k-(i.oldVal-h.b)/h.k),0===i.move)return;i.move<0?(s.y.start-=t,s.y.end-=t):(s.y.start+=t,s.y.end+=t),i.oldVal=e.offsetY,this._flag.click=1,this.mappingY(2),this.drawAxis(),this.drawWave(),this.zoomLine()}else{if(!(o.source>=this._option.grid.left&&o.source<=a.r&&i.source>=this._option.grid.top&&i.source<a.b))return;if(this._flag.zoom)this.drawEnlargement(1);else if(this._flag.addPeakPos.length>0){for(let e=0,t=this._flag.addPeakPos.length;e<t;e++)if(o.oldVal>=this._flag.addPeakPos[e].x&&o.oldVal<=this._flag.addPeakPos[e].x+110&&i.oldVal>=this._flag.addPeakPos[e].y&&i.oldVal<=this._flag.addPeakPos[e].y+40&&this._flag.addPeakPos[e].flag){this._flag.addPeakPos[e].x+=o.move,this._flag.addPeakPos[e].y+=i.move,this.drawAddLabel(2),o.oldVal=o.newVal,i.oldVal=i.newVal;break}this._flag.dragLabel=!0}else{this._flag.tools.flag_subTime&&this.labelLineSpec();let e=this.findNearbyPoint(o.newVal);this._flag.tools.flag_addPeak&&(e.key=this.fft_indexOfWaveX(e.val,this._option.y.data[e.key],1),e.val=this._option.x.data[e.key]),this._flag.line={key:e.key,val:e.val},this.zoomLine()}}}},zoom:e=>{e.stopPropagation();var t=e.offsetX,o=e.offsetY,i=e.deltaY;let l=null,a=2;if(this._option&&this._option.x.data.length>0){if(t>=this._option.grid.left&&t<=this._scope.r.r&&o>=this._option.grid.top&&o<=this._scope.r.b+30){let e,o,s=this.findNearbyPoint(t);if(l={start:.1*(s.val-this._scope.v.x.start),end:.1*(this._scope.v.x.end-s.val)},i<0){if(e=this._scope.v.x.start+l.start,o=this._scope.v.x.end-l.end,e>=o||0>=o)return;this._scope.v.x.start=e,this._scope.v.x.end=o,a=2}else e=this._scope.v.x.start-l.start,o=this._scope.v.x.end+l.end,e<this._computeParams.extremum.x.min||o>this._computeParams.extremum.x.max?a=1:(this._scope.v.x.start=e,this._scope.v.x.end=o,a=2);this.mappingX(a);let n={min:Number.MAX_VALUE,max:Number.MIN_VALUE};n.start=this.findNearbyPoint(this._option.grid.left).key,n.end=this.findNearbyPoint(this._scope.r.r).key+1,n.data=this._option.y.data.slice(n.start,n.end);for(let e=0,t=n.data.length;e<t;e++)n.min>Number(n.data[e])&&(n.min=Number(n.data[e])),n.max<Number(n.data[e])&&(n.max=Number(n.data[e]));n.max===Number.MIN_VALUE&&(n.max=0),this._scope.v.y.start="频谱图"===this._option.title.name?0:n.min,this._scope.v.y.end=1.1*n.max,this.mappingY(a)}this.drawAxis(),this.drawWave(),this.zoomLine()}}},tool:{enlarge:e=>{e.stopPropagation(),this._flag.zoom=Math.abs(--this._flag.zoom),this._flag.click=Math.abs(--this._flag.click)},maxOrMin:()=>{let e=this._dom,t=this._option.grid;this.creat(e.name),this._scope.r={r:e.width-t.right,w:e.width-t.right-t.left,b:e.height-t.bottom,h:e.height-t.top-t.bottom},this.restoreAll(2)},restore:()=>{let e=this._flag;e.click=1,e.toolCheck=-1,e.zoom=0,e.line={key:-1,val:-1};let t=this._drawTools.ctx;for(let e in t)t[e].clearRect(0,0,this._dom.width,this._dom.height);e.addPeakPos.length=0,e.addPeak.length=0,e.tools.flag_subTime=0,e.tools.flag_subFreq=0,e.tools.flag_nx=0,e.labelLine.spectrum.length=0,e.last_xWave={key:-1,val:-1},this._option.tools.restore.formatter(!0),this.restoreAll(1)},timeDifferent:()=>{let e=this._flag,t=e.tools,o=e.line;t.flag_subTime=Math.abs(--t.flag_subTime),t.flag_subTime&&(e.last_xWave={key:o.key,val:o.val}),this.labelLineWave(),this.drawLabelLine()},peakSearch:()=>{let e=this._flag,t=this._option;e.peakIndexArr=this.getPeakIndexArr(t.y.data,10),e.tools.autoPeakNum++,e.tools.autoPeakNum>=10&&(e.tools.autoPeakNum=-1),this.labelLineSpec();let o=-1;for(let t=0,i=e.labelLine.spectrum.length;t<i;t++)if(-1!=e.labelLine.spectrum[t].name.indexOf("p")){o=t;break}o>-1&&(e.line={key:e.labelLine.spectrum[o].xAxis,val:t.x.data[e.labelLine.spectrum[o].xAxis]},this.labelLineSpec()),this._drawTools.ctx.click.clearRect(0,0,this._dom.width,this._dom.height),-1!=e.tools.autoPeakNum&&this.drawLine(e.line)},oneFreq:()=>{let e=this._option;if(0!=e.series.dataMsg.rotateSpeed){let t=this._flag,o=this._computeParams.proportion.x;t.tools.flag_oneF=Math.abs(t.tools.flag_oneF-1),t.toolCheck=1;let i=-1,l=[];i=2==e.series.dataMsg.specType||"NX"==e.x.name?this.indexOfArray(e.x.data,1,0):this.indexOfArray(e.x.data,e.series.dataMsg.oneFreq,0),l.push({name:"1x",xAxis:i}),this._drawTools.ctx.click.clearRect(0,0,this._dom.width,this._dom.height);let a=o.k*e.x.data[l[0].xAxis]+o.b;t.line={key:l[0].xAxis,val:e.x.data[l[0].xAxis]},this.labelLineSpec(),a&&a>=e.grid.left&&a<=this._scope.r.r&&this.drawLine(t.line),t.tools.flag_nx=0,e.tools.oneFreq.formatter(!0)}},subFreq:()=>{let e=this._flag,t=e.tools;t.flag_subFreq=Math.abs(--t.flag_subFreq),e.toolCheck=2,t.flag_subFreq?this.labelLineSpec():this.drawLabelLine()},labelFreq:()=>{let e=this._flag;e.tools.flag_nx=Math.abs(--e.tools.flag_nx),e.toolCheck=2,this.labelLineSpec(),this.drawLabelLine()},addLabel:e=>{e.stopPropagation(),this._flag.line.key>-1&&this.drawAddLabel(1)},cancelLabel:()=>{this._flag.addPeak.length=0,this._flag.addPeakPos.length=0,this._drawTools.ctx.foreground.clearRect(0,0,this._dom.width,this._dom.height)},setPeak:()=>{this._flag.tools.flag_addPeak=!this._flag.tools.flag_addPeak},exportImage:()=>{let e=new Image;const t=this._option,o=this._dom;let i=document.createElement("canvas");i.setAttribute("height",o.height),i.setAttribute("width",o.width);let l=i.getContext("2d");l.beginPath(),l.fillStyle=t.backgroundColor,l.fillRect(0,0,o.width,o.height);for(let e in this._drawTools.canvas)l.drawImage(this._drawTools.canvas[e],0,0);e.src=i.toDataURL("image/png",1);let a=document.createElement("a");a.href=e.src,a.download=""===t.tools.exportImage.imageName?t.title.name:t.tools.exportImage.imageName,a.dispatchEvent(new MouseEvent("click"))},exportData:()=>{const e=this._option;for(var t="\ufeffX,Y\r\n",o=e.tools.exportData.fileName+".csv",i=0,l=e.x.data.length;i<l;i++)t+=e.x.data[i]+","+1*e.y.data[i].toFixed(4)+"\r\n";this.funDownload(t,o)},exportAudio:()=>{var e,t=Number.MIN_VALUE,o=this._option.tools.exportAudio.maxFreq,i=16,l=1,a=l*i/8,s=this._option.y.data.concat(),n=s.length*i/8,r=new Uint8Array(n+44),h=new DataView(r.buffer);for(r.set(new Uint8Array([82,73,70,70])),h.setUint32(4,s.length+44,!0),r.set(new Uint8Array([87,65,86,69]),8),r.set(new Uint8Array([102,109,116,32]),12),h.setUint32(16,16,!0),h.setUint16(20,1,!0),h.setUint16(22,1,!0),h.setUint32(24,o,!0),h.setUint32(28,o*a,!0),h.setUint16(32,a,!0),h.setUint16(34,i,!0),r.set(new Uint8Array([100,97,116,97]),36),h.setUint32(40,n,!0),e=0;e<s.length;e++)Math.abs(s[e])>t&&(t=Math.abs(s[e]));0==t&&(t=1e-4);var d=32760/t;for(e=0;e<s.length;e++)s[e]=Math.round(s[e]*d);r.set(new Uint8Array(new Int16Array(s).buffer),44);var m=this._option.tools.exportAudio.fileName+".wav";this.funDownload(r,m)}}},this.creat(e),this};return o.prototype={constructor:o,creat:function(e){if(void 0===e)return;let t=this._dom,o=this._flag;t.id="windit_"+(new Date).valueOf();for(let t=0,o=e.children.length;t<o;t++)"DIV"===e.children[t].nodeName&&(e.removeChild(e.children[t]),t--,o=e.children.length);t.height=Math.round(e.clientHeight),t.width=Math.round(e.clientWidth),e.style.position="relative";let i=document.createElement("div");e.addEventListener("click",this.event.dom.click,!1),e.addEventListener("mousedown",t=>{o.dragLabel=!1,this._movePos.x.move=0,this._movePos.x.source=t.offsetX,this._movePos.y.source=t.offsetY,this._movePos.x.oldVal=t.offsetX,this._movePos.y.oldVal=t.offsetY;for(let e=0,i=o.addPeakPos.length;e<i;e++){if(t.offsetX>=o.addPeakPos[e].x&&t.offsetX<=o.addPeakPos[e].x+110&&t.offsetY>=o.addPeakPos[e].y&&t.offsetY<=o.addPeakPos[e].y+40){o.addPeakPos[e].flag=1,o.click=0;break}o.click=1}e.addEventListener("mousemove",this.event.dom.dragWave,!1)},!1),e.addEventListener("mouseup",()=>{for(let e=0,t=o.addPeakPos.length;e<t;e++)if(o.addPeakPos[e].flag){o.addPeakPos[e].flag=0;break}this.drawEnlargement(),o.zoom&&this._movePos.x.source>=this._option.grid.left&&this._movePos.x.source<=this._scope.r.r&&this._movePos.y.source>=this._option.grid.top&&this._movePos.y.source<this._scope.r.b&&this.windowEnlargement(),e.removeEventListener("mousemove",this.event.dom.dragWave,!1),o.zoom&&(o.zoom=0,setTimeout(()=>{o.click=1}))},!1),e.addEventListener("mousewheel",this.event.dom.zoom,!1),i.setAttribute("style","height: "+t.height+"px;with: "+t.width+"px;outline: none;"),i.setAttribute("tabindex",1),i.addEventListener("keydown",e=>{if("Escape"===e.key&&27===e.keyCode){o.line={key:-1,val:-1};for(let e=2,o=l.length;e<o;e++)this._drawTools.ctx[l[e]].clearRect(0,0,t.width,t.height);o.addPeak.length=0,o.tools.flag_subTime=0,o.tools.flag_subFreq=0,o.tools.flag_nx=0,o.labelLine.spectrum.length=0,this.zoomLine(),this._option.tools.exportImage.formatter(!0)}else"ArrowLeft"===e.key&&37===e.keyCode?(--o.line.key,o.line.val=this._option.x.data[o.line.key],this.zoomLine()):"ArrowRight"===e.key&&39===e.keyCode&&(++o.line.key,o.line.val=this._option.x.data[o.line.key],this.zoomLine())});const l=["background","data","foreground","failure","subFreq","nxFreq","click","zoom"];for(var a=0,s=l.length;a<s;a++){let o=document.createElement("canvas");o.setAttribute("height",t.height),o.setAttribute("width",t.width),o.setAttribute("style","position: absolute"),this._drawTools.canvas[l[a]]=o,this._drawTools.ctx[l[a]]=o.getContext("2d"),i.appendChild(o),e.appendChild(i)}},setOption:function(e,o=t){if(!e)return;let i=this._flag;i.dataLength||(i.dataLength=e.x.data.length),""===i.spectrumXName&&(i.spectrumXName=e.x.name),""===i.spectrumYName&&(i.spectrumYName=e.y.name);let l=this._option=this.mergeOption(o,e),a=this._dom;0==l.series.dataMsg.rotateSpeed&&(l.series.dataMsg.rotateSpeed=1),this.initParams();let s=l.grid;for(let e in s)"string"==typeof s[e]&&(l.grid[e]="left"===e||"right"===e?a.width*s[e].slice(0,s[e].indexOf("%"))/100:a.height*s[e].slice(0,s[e].indexOf("%"))/100);let n=l.tools;for(let e in n)"setPower"!==e&&"hideLow"!==e&&n[e].dom&&n[e].show&&("setPeak"===e&&(i.tools.flag_addPeak=n[e].show),n[e].dom.addEventListener("click",this.event.tool[e]));this._scope.r={r:a.width-l.grid.right,w:a.width-l.grid.right-l.grid.left,b:a.height-l.grid.bottom,h:a.height-l.grid.top-l.grid.bottom},this.restoreAll(1),this.drawMarkLine()},initParams:function(){let e=this._flag;this._option.changePos&&(e.spectrumXName="",e.line={key:-1,val:-1},e.arr_B.length=0,e.arr_C.length=0,e.toolCheck=-1,e.tools.autoPeakNum=-1,e.addPeak.length=0,e.addPeakPos.length=0,e.labelLine={spectrum:[],wave:[]},e.last_xWave={key:-1,val:-1},e.maxMin=0,e.peakIndexArr=[],e.tools.flag_subFreq=0,e.tools.flag_oneF=0,e.tools.flag_subTime=0,e.tools.flag_wave_extend=0,e.tools.flag_nx=0),this._option.x.name===e.spectrumXName||this._option.y.name===e.spectrumYName?e.line.val=this._option.x.data[e.line.key]:(e.line.key=this.indexOfArray(this._option.x.data,e.line.val,0),e.spectrumXName=this._option.x.name,e.spectrumYName=this._option.y.name),e.zoom=0,e.click=1,this._scope={v:{x:{start:null,end:null,length:null},y:{start:null,end:null,length:null}},r:{r:null,w:null,b:null,h:null}},this._movePos={x:{oldVal:0,newVal:0,move:0,source:0,addLabel:0},y:{oldVal:0,newVal:0,move:0,source:0,addLabel:0}};const t=this._drawTools.ctx;for(let e in t)t[e].clearRect(0,0,this._dom.width,this._dom.height)},mergeOption:function(e,t){for(var o in t)e[o]&&"[object Object]"===e[o].toString()?this.mergeOption(e[o],t[o]):e[o]=t[o];return e},formatDateStr:function(e,t=1){let o,i={};return i.yy=new Date(e).getFullYear(),i.mm=new Date(e).getMonth()+1,i.mm<10&&(i.mm="0"+i.mm),i.dd=new Date(e).getDate(),i.dd<10&&(i.dd="0"+i.dd),o=3===t?i.mm+"-"+i.dd:i.yy+"-"+i.mm+"-"+i.dd,2!==t&&3!==t||(i.h=new Date(e).getHours(),i.h<10&&(i.h="0"+i.h),i.m=new Date(e).getMinutes(),i.m<10&&(i.m="0"+i.m),i.s=new Date(e).getSeconds(),i.s<10&&(i.s="0"+i.s),o+=" "+i.h+":"+i.m+":"+i.s),o},restoreAll:function(e){this.mappingX(e),this.mappingY(e),this.drawAxis(),this.drawWave(),this.zoomLine()},mappingX:function(e){let t=this._scope,o=this._computeParams;if(1===e){o.extremum.x={min:Number.MAX_VALUE,max:Number.MIN_VALUE};let e=this._option.x.data;e.map(e=>{if("object"==typeof e&&e.length>0){if(!(e.length>0))return;e.map(e=>{o.extremum.x.max<e&&(o.extremum.x.max=e),o.extremum.x.min>e&&(o.extremum.x.min=e)})}else o.extremum.x.max<e&&(o.extremum.x.max=e),o.extremum.x.min>e&&(o.extremum.x.min=e)});let i=t.r.w/(o.extremum.x.max-o.extremum.x.min),l=(t.r.r+this._option.grid.left-i*(o.extremum.x.max+o.extremum.x.min))/2;o.proportion.x={k:i,b:l},t.v.x.start=o.extremum.x.min,t.v.x.end=o.extremum.x.max,t.v.x.length=o.extremum.x.max-o.extremum.x.min}else{let e=t.r.w/(t.v.x.end-t.v.x.start),i=(t.r.r+this._option.grid.left-e*(t.v.x.end+t.v.x.start))/2;t.v.x.length=t.v.x.end-t.v.x.start,o.proportion.x={k:e,b:i}}},mappingY:function(e){let t=this._scope,o=this._computeParams;if(1===e){let e=this._option.y.data;"category"===this._option.x.type?(o.extremum.y={min:Number.MAX_VALUE,max:Number.MIN_VALUE},e.map(e=>{if("object"==typeof e&&e.length>0){if(!(e.length>0))return;e.map(e=>{o.extremum.y.max<e&&(o.extremum.yb.max=e),o.extremum.y.min>e&&(o.extremum.x.min=e)})}else o.extremum.y.max<e&&(o.extremum.y.max=e),o.extremum.y.min>e&&(o.extremum.y.min=e)})):(o.extremum.y={min:0,max:Number.MIN_VALUE},e.map(e=>{if("object"==typeof e&&e.length>0){if(!(e.length>0))return;e.map(e=>{o.extremum.y.max<e&&(o.extremum.yb.max=e)})}else o.extremum.y.max<e&&(o.extremum.y.max=e)})),t.v.y.start=o.extremum.y.min,t.v.y.end=1.2*o.extremum.y.max;let i=t.r.h/(t.v.y.start-t.v.y.end),l=t.r.b-t.v.y.start*i;o.proportion.y={k:i,b:l}}else{let e,i,l=t.v.y.start-t.v.y.end==0?-1:t.v.y.start-t.v.y.end;e=t.r.h/l,i=t.r.b-t.v.y.start*e,o.proportion.y={k:e,b:i}}t.v.y.length=t.v.y.end-t.v.y.start},drawAxis:function(){let e=this._drawTools.ctx.background;if(e.clearRect(0,0,this._dom.width,this._dom.height),e.beginPath(),e.save(),e.lineWidth=this._option.y.lineStyle.width,e.strokeStyle=this._option.y.lineStyle.color,e.moveTo(this._option.grid.left+.5,this._scope.r.b+.5),e.lineTo(this._option.grid.left+.5,this._option.grid.top),e.stroke(),e.restore(),e.font=this._option.y.nameStyle.weight+" "+this._option.y.nameStyle.size+" "+this._option.y.nameStyle.family,e.textBaseline="bottom",e.textAlign="center",e.fillStyle=this._option.y.nameStyle.color,e.fillText(this._option.y.name,this._option.grid.left,this._option.grid.top-5),e.beginPath(),e.lineWidth=this._option.x.lineStyle.width,e.strokeStyle=this._option.x.lineStyle.color,e.moveTo(this._option.grid.left+.5,this._scope.r.b+.5),e.lineTo(this._scope.r.r+.5,this._scope.r.b+.5),e.font=this._option.x.nameStyle.weight+" "+this._option.x.nameStyle.size+" "+this._option.x.nameStyle.family,e.textBaseline="middle",e.textAlign="right",e.fillStyle=this._option.x.nameStyle.color,e.fillText(this._option.x.name,this._scope.r.r,this._scope.r.b+15),e.stroke(),e.restore(),this._option.title.show&&""!==this._option.title.name){let t;switch(e.beginPath(),e.font=this._option.title.fontStyle.weight+" "+this._option.title.fontStyle.size+" "+this._option.title.fontStyle.family,e.textAlign=this._option.title.fontStyle.align,e.fillStyle=this._option.title.fontStyle.color,e.textBaseline="top",this._option.title.fontStyle.align){case"left":t=0;break;case"center":t=this._dom.width/2;break;case"right":t=this._dom.width}e.fillText(this._option.title.name,t,5)}if(0===this._option.x.data||0===this._option.y.data.length)return;e.beginPath(),e.lineWidth=this._option.x.lineStyle.width,e.strokeStyle=this._option.x.lineStyle.color,e.textAlign="center",e.textBaseline="middle",e.save();let t={x:{},y:{}};t.x.iSegNum=Math.round(this._scope.r.w/25),t.x.minSeg=this._scope.v.x.length/t.x.iSegNum,t.x.mi=Math.round(Math.log(t.x.minSeg)*Math.LOG10E),t.x.nScale=Math.pow(10,t.x.mi),t.x.seg=t.x.nScale/5,t.x.seg<t.x.minSeg&&(t.x.seg=t.x.nScale/2),t.x.seg<t.x.minSeg&&(t.x.seg=t.x.nScale),t.x.seg<t.x.minSeg&&(t.x.seg=2*t.x.nScale),t.x.seg<t.x.minSeg&&(t.x.seg=5*t.x.nScale),t.x.seg<t.x.minSeg&&(t.x.seg=10*t.x.nScale),t.y.iSegNum=Math.round(this._scope.r.h/20),t.y.minSeg=this._scope.v.y.length/t.y.iSegNum,t.y.mi=Math.round(Math.log(t.y.minSeg)*Math.LOG10E),t.nScaleY=Math.pow(10,t.y.mi),t.y.seg=t.nScaleY/5,t.y.seg<t.y.minSeg&&(t.y.seg=t.nScaleY/2),t.y.seg<t.y.minSeg&&(t.y.seg=t.nScaleY),t.y.seg<t.y.minSeg&&(t.y.seg=2*t.nScaleY),t.y.seg<t.y.minSeg&&(t.y.seg=5*t.nScaleY),t.y.seg<t.y.minSeg&&(t.y.seg=10*t.nScaleY),t.x.seg=parseFloat(t.x.seg.toPrecision(7).toString()),t.y.seg=parseFloat(t.y.seg.toPrecision(7).toString()),e.font=this._option.x.fontStyle.size+" "+this._option.x.fontStyle.family,e.fillStyle=this._option.x.fontStyle.color;let o={x:0,y:0},i=this._scope.v.x.end-this._scope.v.x.start,l="time"===this._option.x.type?this._scope.v.x.start:0;for(let a=l,s=0,n=this._scope.v.x.end-t.x.seg;a<n;a+=t.x.seg,s++){let l=a*this._computeParams.proportion.x.k+this._computeParams.proportion.x.b;if(l>=this._option.grid.left&&l<=this._scope.r.r)if("category"===this._option.x.type&&s%2==0){let i=parseFloat(a.toPrecision(6)).toString();if(-1!==i.indexOf(".")){let e=i.slice(i.indexOf("."));o.x<=e.length?o.x=e.length:i+="0"}else if(o.x>0){let e=".";for(let t=1;t<o.x;t++)e+="0";i+=e}else t.x.seg<.5&&(i+=".0");e.fillText(i,l,this._scope.r.b+15),e.moveTo(l+.5,this._scope.r.b),e.lineTo(l+.5,this._scope.r.b+5)}else if("time"===this._option.x.type&&s%5==0){let t=i>864e5?this.formatDateStr(a,1):this.formatDateStr(a,3);e.fillText(t,l,this._scope.r.b+15),e.moveTo(l+.5,this._scope.r.b),e.lineTo(l+.5,this._scope.r.b+5)}}e.stroke(),e.restore(),e.font=this._option.y.fontStyle.size+" "+this._option.y.fontStyle.family,e.textAlign="right",e.fillStyle=this._option.y.fontStyle.color;let a=(this._scope.v.y.end-this._scope.v.y.start)/t.y.seg>7?2:1;t.y.seg<=Number.MIN_VALUE&&(t.y.seg=1e-5);for(let i=0,l=0;i>=this._scope.v.y.start;i-=t.y.seg,l++){let t=i*this._computeParams.proportion.y.k+this._computeParams.proportion.y.b;if(t<=this._scope.r.b&&t>=this._option.grid.top&&l%a==0&&0!==l){let l=parseFloat(i.toPrecision(7)).toString();if(-1!==l.indexOf(".")){let e=l.slice(l.indexOf("."));o.y<=e.length?o.y=l.slice(l.indexOf(".")).length:l+="0"}else if(o.y>0){let e=".";for(let t=1;t<o.y;t++)e+="0";l+=e}e.fillText(l,this._option.grid.left-10,t+.5),e.moveTo(this._option.grid.left,t+.5),e.lineTo(this._option.grid.left-5,t+.5)}}for(let i=0,l=0;i<=this._scope.v.y.end;i+=t.y.seg,l++){let t=i*this._computeParams.proportion.y.k+this._computeParams.proportion.y.b,s=parseFloat(i.toPrecision(7)).toString();if(t<=this._scope.r.b&&t>=this._option.grid.top&&l%a==0){if(-1!==s.indexOf(".")){let e=s.slice(s.indexOf("."));o.y<=e.length?o.y=s.slice(s.indexOf(".")).length:s+="0"}else if(o.y>0){let e=".";for(let t=1;t<o.y;t++)e+="0";s+=e}s>0?e.fillText(s,this._option.grid.left-10,t+.5):s<0?e.fillText(s,this._option.grid.left-10,t+.5):e.fillText(0,this._option.grid.left-10,t+.5),e.moveTo(this._option.grid.left,t+.5),e.lineTo(this._option.grid.left-5,t+.5)}}e.stroke(),e.beginPath(),e.strokeStyle=this._option.y.splitLineStyle.color,e.lineWidth=this._option.y.splitLineStyle.width;for(let o=0,i=0;o>=this._scope.v.y.start;o-=t.y.seg,i++){let t=o*this._computeParams.proportion.y.k+this._computeParams.proportion.y.b;t<=this._scope.r.b&&t>=this._option.grid.top&&i%a==0&&0!==i&&(e.moveTo(this._option.grid.left,t+.5),e.lineTo(this._scope.r.r,t+.5))}for(let o=0,i=0;o<=this._scope.v.y.end;o+=t.y.seg,i++){let t=o*this._computeParams.proportion.y.k+this._computeParams.proportion.y.b;t<=this._scope.r.b&&t>=this._option.grid.top&&i%a==0&&(e.moveTo(this._option.grid.left,t+.5),e.lineTo(this._scope.r.r,t+.5))}e.stroke()},drawLine:function(e){let t=this._computeParams.proportion,o=this._option,i=this._drawTools.ctx.click,l={x:{oldVal:0==e.key?t.x.k*e.val+t.x.b+.5:t.x.k*e.val+t.x.b,newVal:t.x.k*e.val+t.x.b},y:{oldVal:o.grid.top,newVal:this._scope.r.b}},a={x:t.x.k*e.val+t.x.b,y:o.y.data[e.key]*t.y.k+t.y.b};if(l.x.oldVal>=o.grid.left&&l.x.oldVal<=this._scope.r.r&&a.y-3>=o.grid.top&&a.y<=this._scope.r.b){if(i.clearRect(0,0,this._dom.width,this._dom.height),o.toolTip.symbol.show){let e=o.toolTip.symbol.size;i.beginPath(),i.lineWidth=1,i.strokeStyle=o.toolTip.lineStyle.color,i.moveTo(l.x.oldVal,l.y.oldVal),i.lineTo(l.x.newVal,a.y-e),i.moveTo(o.grid.left,a.y),i.lineTo(a.x-e,a.y),i.moveTo(a.x+e,a.y),i.lineTo(this._scope.r.r,a.y),i.stroke(),i.beginPath(),i.arc(a.x,a.y,e,0,2*Math.PI),i.fillStyle=""!==o.toolTip.symbol.color?o.toolTip.symbol.color:o.toolTip.lineStyle.color,i.fill(),i.moveTo(l.x.oldVal,a.y+e),i.lineTo(l.x.newVal,l.y.newVal),i.stroke()}else i.beginPath(),i.lineWidth=1,i.strokeStyle=o.toolTip.lineStyle.color,i.moveTo(l.x.oldVal,l.y.oldVal),i.lineTo(l.x.newVal,l.y.newVal),i.moveTo(o.grid.left,a.y),i.lineTo(this._scope.r.r,a.y),i.stroke();let t="number"==typeof o.y.data[e.key]?o.y.data[e.key].toFixed(4):o.y.data[e.key],s=0;switch(t.length){case 7:s=60;break;case 8:s=70;break;case 9:s=80;break;default:s=50}i.beginPath(),i.fillStyle=o.toolTip.background.color,i.fillRect(o.grid.left-s-1,a.y-10,s,20),i.font=o.toolTip.fontStyle.weight+" "+o.toolTip.fontStyle.size+" "+o.toolTip.fontStyle.family;let n=12*e.val.toString().length;"category"===o.x.type?(i.fillStyle=o.toolTip.background.color,i.fillRect(l.x.oldVal-n/2,l.y.newVal+1,n,20),i.fillStyle=o.toolTip.fontStyle.color,i.textBaseline="top",i.textAlign="center",i.fillText(e.val,l.x.oldVal,l.y.newVal+5),i.textBaseline="middle",i.textAlign="right",i.fillText(t,o.grid.left-5,a.y)):"time"===o.x.type&&(i.fillStyle=o.toolTip.background.color,i.fillRect(l.x.oldVal-n/2,l.y.newVal+1,n,20),i.fillStyle=o.toolTip.fontStyle.color,i.textBaseline="middle",i.textAlign="right",i.fillText(t,o.grid.left-5,a.y),i.textBaseline="top",i.textAlign="center",i.fillText(this.formatDateStr(e.val,2),l.x.oldVal,l.y.newVal+5))}},drawWave:function(){let e,t,o=this._computeParams.proportion,i=this._drawTools.ctx.data,l=o.x.k,a=o.x.b,s=o.y.k,n=o.y.b,r=this._option,h=r.x.data,d=r.y.data,m=r.series,p=this._scope.r;i.clearRect(0,0,this._dom.width,this._dom.height),i.beginPath(),i.lineWidth=m.lineStyle.width,i.strokeStyle=m.lineStyle.color;let f=Math.round((r.grid.left-a)/l*1e8)/1e8,x=Math.round((p.r-a)/l*1e8)/1e8,g=Math.round((r.grid.top-n)/s*1e8)/1e8,c=Math.round((p.b-n)/s*1e8)/1e8;"line"===m.type?(h.map((o,r,h)=>{if("object"==typeof o){if(!(o.length>0))return;o.map((o,r,m)=>{if(r<h.length){let h=m[r+1],p=d[r],y=d[r+1];o>=f&&h<=x&&p<=g&&p>=c&&y>=c&&y<=g&&(e={oVal:l*o+a,nVal:l*h+a},t={oVal:p*s+n,nVal:y*s+n},i.moveTo(e.oVal,t.oVal),i.lineTo(e.nVal,t.nVal))}})}else if(r<h.length){let m=h[r+1],p=d[r],y=d[r+1];o>=f&&m<=x&&p<=g&&p>=c&&y>=c&&y<=g&&(e={oVal:l*o+a,nVal:l*m+a},t={oVal:p*s+n,nVal:y*s+n},i.moveTo(e.oVal,t.oVal),i.lineTo(e.nVal,t.nVal))}}),i.stroke(),m.symbol.show&&h.map((e,t)=>{let o=d[t];e>=f&&e<=x&&o<=g&&o>=c&&(e=e*l+a,o=o*s+n,i.beginPath(),i.strokeStyle=m.lineStyle.color,i.fillStyle=""===m.symbol.color?"#fff":m.symbol.color,i.arc(e,o,3,0,2*Math.PI),i.stroke(),i.fill())})):"bar"===m.type&&(h.map((e,o)=>{t=d[o];let r=n<=p.b?n:p.b;e>=f&&e<=x&&t<=g&&t>=c&&(e=e*l+a,t=t*s+n,i.moveTo(e,r),i.lineTo(e,t+1))}),i.stroke())},findNearbyPoint:function(e){let t,o,i={val:0,key:0,dx:0},l=this._option.x.data,a=this._computeParams.proportion.x,s=a.k,n=a.b;for(var r=0,h=l.length;r<h;r++)0===r?(t=Math.abs(l[r]*s+n-e),o=Math.abs(l[r+1]*s+n-e),i=t>o?{val:l[r+1],key:r+1,dx:o}:{val:l[r],key:r,dx:t}):(t=Math.abs(l[r]*s+n-e),i.dx>t&&(i={val:l[r],key:r,dx:t}));return i},zoomLine:function(){const e=this._flag;switch(this._drawTools.ctx.click.clearRect(0,0,this._dom.width,this._dom.height),e.toolCheck){case 0:this.drawLine(e.line);break;case 1:this.event.tool.oneFreq();break;case 2:(e.tools.flag_nx||e.tools.flag_subFreq)&&this.labelLineSpec(),e.tools.flag_subTime&&this.labelLineWave(),this.drawLabelLine();break;case 3:this.event.tool.peakSearch()}e.addPeakPos.length>0&&this.drawAddLabel(2),this._option.series.markLine.data.length>0&&this.drawMarkLine()},drawEnlargement:function(e){let t=this._drawTools.ctx.zoom,o=this._scope,i=this._option,l=this._movePos.x,a=this._computeParams.proportion.x;if(t.clearRect(0,0,this._dom.width,this._dom.height),e&&(this._flag.click=0,t.fillStyle="rgba(0, 0, 0, 0.2)",l.newVal>=i.grid.left&&l.newVal<=o.r.r)){let e={oldPos:this.findNearbyPoint(l.oldVal),newPos:this.findNearbyPoint(l.newVal)},s=[];e.oldPos.key===e.newPos.key&&(l.move>=0?(e.newPos.key++,e.newPos.val=i.x.data[e.newPos.key]):(e.newPos.key--,e.newPos.val=i.x.data[e.newPos.key])),s=l.move>=0?i.y.data.slice(e.oldPos.key,e.newPos.key+1):i.y.data.slice(e.newPos.key,e.oldPos.key+1);let n={min:Number.MAX_VALUE,max:Number.MIN_VALUE};for(let e=0,t=s.length;e<t;e++)n.max<s[e]&&(n.max=s[e]),n.min>s[e]&&(n.min=s[e]);o.v.y.end=n.max,o.v.y.start=n.min,l.oldVal=e.oldPos.val*a.k+a.b,l.newVal=e.newPos.val*a.k+a.b,l.move=l.newVal-l.oldVal,l.move>=0?t.fillRect(l.oldVal,i.grid.top,l.move,o.r.h):t.fillRect(l.newVal,i.grid.top,Math.abs(l.move),o.r.h)}},windowEnlargement:function(){let e={start:null,end:null};const t=this._movePos.x,o=this._computeParams.proportion.x,i=this._scope;0!==t.move&&(t.move>0?(e.start=(t.oldVal-o.b)/o.k,e.end=(t.newVal-o.b)/o.k):(e.start=(t.newVal-o.b)/o.k,e.end=(t.oldVal-o.b)/o.k),i.v.x.start=e.start,i.v.x.end=e.end,this.mappingX(2),this.mappingY(2),this.drawAxis(),this.drawWave(),this.zoomLine())},fft_indexOfWaveX:function(e,t,o){try{let t=this._option.x,h=this._option.y;if(null==t.data||0==t.data.length)return-1;var i=t.data.length/800;1==o&&(i=Math.round(i/4)),i<3&&(i=3);var l=this.indexOfArray(t.data,e,0);l>=t.data.length?l=t.data.length:l>0&&Math.abs(t.data[l]-e)>Math.abs(t.data[l-1]-e)&&(l-=1);var a=l-i,s=l+i,n=l;a<=0&&(a=0),s>=h.data.length&&(s=h.data.length-1);for(var r=a;r<=s;r++)h.data[r]>h.data[n]&&(n=r);return n}catch(e){}return-1},indexOfArray:function(e,t,o){for(var i=-1,l=!1,a=Number.POSITIVE_INFINITY,s=0;s<e.length;s++){switch(o){case-1:l=e[s]-t<=0&&a>Math.abs(e[s]-t);break;case 0:l=a>Math.abs(e[s]-t);break;case 1:l=e[s]-t>=0&&a>Math.abs(e[s]-t)}if(l&&(a=Math.abs(e[s]-t),i=s,0==a))break}return i},labelLineWave:function(){let e=this._flag;e.labelLine.wave.length>0&&(e.labelLine.wave.length=0);var t=[],o=-1,i=-1,l=-1,a=-1;if(1==e.tools.flag_subTime&&-1!=e.last_xWave.key?(i=e.last_xWave.val,o=e.last_xWave.key,t.push({name:i+","+o.toFixed(4),xAxis:o}),e.tools.flag_wave_extend=1):1==e.tools.flag_subTime&&-1==e.last_xWave.key&&(e.last_xWave={key:0,val:this._option.x.data[0]},t.push({name:"0,"+this._option.x.data[0].toFixed(4),xAxis:0}),e.tools.flag_wave_extend=1),e.tools.flag_wave_extend&&1==e.tools.flag_subTime&&e.line.key!==e.last_xWave.key&&-1!=e.line.val){if(l=e.line.key,a=Math.abs(l-o),0==a)return;for(var s=l%a,n=s;n<this._option.x.data.length;n+=a)n!=o&&t.push({name:"",xAxis:n,lineStyle:{color:"red"}})}t.length>0&&(e.labelLine.wave=t)},labelLineSpec:function(){let e=this._flag,t=this._option;e.labelLine.spectrum.length>0&&(e.labelLine.spectrum.length=0);var o=[],i=-1,l=0,a=-1,s=-1;if(e.peakIndexArr.length>e.tools.autoPeakNum&&o.push({name:e.tools.autoPeakNum+1+"p",xAxis:e.peakIndexArr[e.tools.autoPeakNum]}),-1==e.tools.autoPeakNum&&(o.length=0),1==e.tools.flag_subFreq){
e.arr_C=[],e.arr_B[0]>=0&&-1!=e.arr_B[0]||(e.arr_B[0]=0);var n=e.arr_B[0];if(1==e.tools.flag_nx){e.arr_B=[];for(l=0;l<10;l++){var r=n*(l+1);if(r>=t.x.data.length)break;e.arr_B.push(r)}}if(i=e.arr_B[0],a=e.line.key,s=Math.abs(a-i),0!=s){var h=a%s,d=i-3*s,m=i+3*s;d<h&&(d=h),m>t.x.data.length&&(m=t.x.data.length);for(var p=d;p<=m;p+=s){var f={};p==i?(f.line=!0,f.value=p):(f.line=!1,f.value=p),e.arr_C.push(f)}}}else if(1==e.tools.flag_nx){e.arr_B=[];for(l=0;l<10;l++)if(-1==e.line.val)e.arr_B=[];else{if(2==t.series.dataMsg.specType){if(e.line.val*(l+1)>=t.series.dataMsg.spectral/2.56)break}else if(e.line.val*(l+1)>=t.x.data[t.x.data.length-1])break;if(0==e.tools.flag_nx&&l>0)break;var x=this.indexOfArray(t.x.data,e.line.val*(l+1),0);e.arr_B.push(x)}}else e.arr_B[0]=e.line.key;if(1==e.tools.flag_nx){var g=new Array(e.arr_B.length);for(l=0;l<e.arr_B.length;l++){let i=e.arr_B[l]>=0?e.arr_B[l]:0;g[l]=this.fft_indexOfWaveX(t.x.data[i],t.y.data[i],1),e.tools.flag_addPeak?0==l?o.push({xAxis:i,name:l+1+"X,"+Number(t.x.data[i]).toFixed(1)+t.x.name+","+t.y.data[i].toFixed(4),lineStyle:{color:t.toolTip.lineStyle.color}}):o.push({name:l+1+"X,"+Number(t.x.data[g[l]]).toFixed(1)+t.x.name+","+t.y.data[g[l]].toFixed(4),xAxis:g[l],lineStyle:{color:t.toolTip.lineStyle.color}}):o.push({name:l+1+"X,"+Number(t.x.data[i]).toFixed(1)+t.x.name+","+t.y.data[i].toFixed(4),xAxis:i,lineStyle:{color:t.toolTip.lineStyle.color}})}}if(1==e.tools.flag_subFreq){var c=new Array(e.arr_C.length);for(l=0;l<e.arr_C.length;l++)c[l]=this.fft_indexOfWaveX(t.x.data[e.arr_C[l].value],t.y.data[e.arr_C[l].value],1),1==e.arr_C[l].line?1==e.tools.flag_nx?o.push({name:"",xAxis:e.arr_C[l].value}):o.push({name:t.x.data[e.arr_C[l].value].toFixed(4)+","+t.y.data[e.arr_C[l].value].toFixed(4),xAxis:e.arr_C[l].value}):o.push({name:"",xAxis:e.arr_C[l].value,lineStyle:{color:"red"}})}o.length>0&&(e.labelLine.spectrum=o)},drawLabelLine:function(){let e=this._drawTools.ctx.subFreq,t=this._drawTools.ctx.click,o=this._flag,i=this._option,l=i.x,a=i.y,s=this._scope.r,n=this._computeParams.proportion,r=n.x.k,h=n.x.b,d=n.y.k,m=n.y.b;if(e.clearRect(0,0,this._dom.width,this._dom.height),t.clearRect(0,0,this._dom.width,this._dom.height),o.tools.flag_subTime&&i.tools.timeDifferent.show&&o.line.key>-1){if(o.last_xWave.key!==o.line.key){let t=null;"s"===l.name?(t={x:l.data[o.line.key]*r+h,time:"时间："+l.data[o.line.key]+l.name,timeDif:"时间差："+Math.round(1e4*Math.abs(o.line.val-l.data[o.last_xWave.key]))/1e4+l.name,subFreq:"频率差："+Math.round(1/Math.abs(o.last_xWave.val-o.line.val)*1e4)/1e4+"Hz",amplitude:"幅值："+Math.round(1e4*a.data[o.line.key])/1e4+a.name},-1===o.last_xWave.key&&(t.timeDif="时间差："+Math.round(1e4*Math.abs(o.line.val-l.data[0]))/1e4+l.name),t.x-i.grid.left>=s.w/2&&(t.x-=110),t.x>=i.grid.left&&t.x+110<=s.r&&(e.beginPath(),e.fillStyle=i.toolTip.background.color,e.fillRect(t.x,i.grid.top,110,70),e.font=a.fontStyle.size+" "+a.fontStyle.family,e.fillStyle=i.series.lineStyle.color,e.textBaseline="top",e.fillText(t.time,t.x+10,i.grid.top+8),e.fillText(t.timeDif,t.x+10,i.grid.top+23),e.fillText(t.subFreq,t.x+10,i.grid.top+38),e.fillText(t.amplitude,t.x+10,i.grid.top+53))):"smpl"===l.name&&(t={x:o.line.val*r+h,time:"点序："+o.line.val,timeDif:"点数差："+(o.line.val-l.data[o.last_xWave.key]),amplitude:"波形值："+a.data[o.line.key].toFixed(4)},-1===o.last_xWave.key&&(t.timeDif="点数差："+(o.line.val-l.data[0])),t.x-i.grid.left>=s.w/2&&(t.x-=106),t.x>=i.grid.left&&t.x+110<=s.r&&(e.beginPath(),e.fillStyle=i.toolTip.background.color,e.fillRect(t.x,i.grid.top,106,60),e.font=a.fontStyle.size+" "+a.fontStyle.family,e.fillStyle=i.series.lineStyle.color,e.textBaseline="top",e.fillText(t.time,t.x+10,i.grid.top+8),e.fillText(t.timeDif,t.x+10,i.grid.top+23),e.fillText(t.amplitude,t.x+10,i.grid.top+38)))}if(i.toolTip.symbol.show){let t=i.toolTip.symbol.size;for(let n=1,p=o.labelLine.wave.length;n<p;n++){let p={x:l.data[o.labelLine.wave[n].xAxis]*r+h,y:a.data[o.labelLine.wave[n].xAxis]*d+m};p.x>=i.grid.left&&p.x<=s.r&&p.y>=i.grid.top&&p.y<=s.b&&(e.beginPath(),e.strokeStyle=o.labelLine.wave[n].lineStyle.color,e.fillStyle=o.labelLine.wave[n].lineStyle.color,e.moveTo(p.x,i.grid.top),e.lineTo(p.x,p.y-t),e.stroke(),e.beginPath(),e.arc(p.x,p.y,t,0,2*Math.PI),e.fillStyle=""!==i.toolTip.symbol.color?i.toolTip.symbol.color:o.labelLine.wave[n].lineStyle.color,e.fill(),e.moveTo(p.x,p.y+t),e.lineTo(p.x,s.b),e.stroke())}}else{e.beginPath();for(let t=1,n=o.labelLine.wave.length;t<n;t++){let n={x:l.data[o.labelLine.wave[t].xAxis]*r+h,y:a.data[o.labelLine.wave[t].xAxis]*d+m};n.x>=i.grid.left&&n.x<=s.r&&n.y>=i.grid.top&&n.y<=s.b&&(e.strokeStyle=o.labelLine.wave[t].lineStyle.color,e.fillStyle=o.labelLine.wave[t].lineStyle.color,e.moveTo(n.x,i.grid.top),e.lineTo(n.x,s.b))}e.stroke()}this.drawLine(o.last_xWave)}if(o.tools.flag_subFreq&&i.tools.subFreq.show&&o.line.key>-1){let t=l.name,n={x:l.data[o.line.key]*r+h,freq:"频率："+o.line.val+t,nxFreq:"倍频："+Math.round(60*o.line.val/i.series.dataMsg.rotateSpeed*1e4)/1e4+"NX",subFreq:"差频："+Math.abs(o.line.val-l.data[o.arr_B[0]]).toFixed(4)+t,amplitude:"幅值："+a.data[o.line.key].toFixed(4)};if("NX"===t&&(n.freq="频率："+Math.round(o.line.val*i.series.dataMsg.rotateSpeed/60*1e4)/1e4+"Hz",n.nxFreq="倍频："+o.line.val+t),n.x-i.grid.left>=s.w/2&&(n.x-=110),n.x>=i.grid.left&&n.x+110<=s.r&&(e.beginPath(),e.lineWidth=1,e.fillStyle=i.toolTip.background.color,e.fillRect(n.x,i.grid.top,110,70),e.font=a.fontStyle.size+" "+a.fontStyle.family,e.fillStyle=i.series.lineStyle.color,e.textBaseline="top",e.fillText(n.freq,n.x+10,i.grid.top+8),e.fillText(n.nxFreq,n.x+10,i.grid.top+23),e.fillText(n.subFreq,n.x+10,i.grid.top+38),e.fillText(n.amplitude,n.x+10,i.grid.top+53)),i.toolTip.symbol.show){let t=i.toolTip.symbol.size;for(let n=0,p=o.labelLine.spectrum.length;n<p;n++){if(""===o.labelLine.spectrum[n].name&&o.labelLine.spectrum[n].lineStyle){e.strokeStyle=o.labelLine.spectrum[n].lineStyle.color,e.fillStyle=""!==i.toolTip.symbol.color?i.toolTip.symbol.color:o.labelLine.spectrum[n].lineStyle.color;let p=l.data[o.labelLine.spectrum[n].xAxis]*r+h,f=a.data[o.labelLine.spectrum[n].xAxis]*d+m;p>=i.grid.left&&p<=s.r&&f>=i.grid.top&&f<=s.b&&(e.beginPath(),e.moveTo(p,i.grid.top),e.lineTo(p,f-t),e.stroke(),e.beginPath(),e.arc(p,f,t,0,2*Math.PI),e.fill(),e.moveTo(p,f+t),e.lineTo(p,s.b),e.stroke())}if(!o.labelLine.spectrum[n].lineStyle&&-1===o.labelLine.spectrum[n].name.indexOf("p")&&-1===o.labelLine.spectrum[n].name.indexOf("x")){let p={x:l.data[o.labelLine.spectrum[n].xAxis]*r+h,y:a.data[o.labelLine.spectrum[n].xAxis]*d+m};p.x>=i.grid.left&&p.x<=s.r&&p.y>=i.grid.top&&p.y<=s.b&&(e.beginPath(),e.strokeStyle=i.toolTip.lineStyle.color,e.moveTo(p.x,i.grid.top),e.lineTo(p.x,p.y-t),e.stroke(),e.beginPath(),e.fillStyle=""!==i.toolTip.symbol.color?i.toolTip.symbol.color:i.toolTip.lineStyle.color,e.arc(p.x,p.y,t,0,2*Math.PI),e.fill(),e.moveTo(p.x,p.y+t),e.lineTo(p.x,s.b),e.stroke())}}}else for(let t=0,n=o.labelLine.spectrum.length;t<n;t++){if(""===o.labelLine.spectrum[t].name&&o.labelLine.spectrum[t].lineStyle){e.strokeStyle=o.labelLine.spectrum[t].lineStyle.color,e.fillStyle=o.labelLine.spectrum[t].lineStyle.color;let n=l.data[o.labelLine.spectrum[t].xAxis]*r+h,p=a.data[o.labelLine.spectrum[t].xAxis]*d+m;n>=i.grid.left&&n<=s.r&&p>=i.grid.top&&p<=s.b&&(e.beginPath(),e.moveTo(n,i.grid.top),e.lineTo(n,s.b),e.stroke())}if(!o.labelLine.spectrum[t].lineStyle&&-1===o.labelLine.spectrum[t].name.indexOf("p")&&-1===o.labelLine.spectrum[t].name.indexOf("x")){let n={x:l.data[o.labelLine.spectrum[t].xAxis]*r+h,y:a.data[o.labelLine.spectrum[t].xAxis]*d+m};n.x>=i.grid.left&&n.x<=s.r&&n.y>=i.grid.top&&n.y<=s.b&&(e.beginPath(),e.strokeStyle=i.toolTip.lineStyle.color,e.moveTo(n.x,i.grid.top),e.lineTo(n.x,s.b),e.stroke())}}}if(o.tools.flag_nx&&i.tools.labelFreq.show)if(i.toolTip.symbol.show){let e=i.toolTip.symbol.size;for(let n=0,p=o.labelLine.spectrum.length;n<p;n++)if(""!==o.labelLine.spectrum[n].name&&o.labelLine.spectrum[n].lineStyle){let p=l.data[o.labelLine.spectrum[n].xAxis]*r+h,f=a.data[o.labelLine.spectrum[n].xAxis]*d+m;if(p>i.grid.left&&p<=s.r&&f>=i.grid.top&&f<=s.b){let l=o.labelLine.spectrum[n].name,r=o.labelLine.spectrum[n].lineStyle.color;t.beginPath(),t.lineWidth=1,t.strokeStyle=r,t.fillStyle=r,t.font=a.fontStyle.size+" "+a.fontStyle.family,t.save(),t.moveTo(p,i.grid.top),t.lineTo(p,f-e),t.translate(p-s.h,110+i.grid.top),t.rotate(-90*Math.PI/180),t.textAlign="right",t.textBaseline="bottom",t.fillText(l,40+i.grid.top,s.h),t.restore(),t.stroke(),t.beginPath(),t.arc(p,f,e,0,2*Math.PI),t.fillStyle=""!==i.toolTip.symbol.color?i.toolTip.symbol.color:r,t.fill(),t.moveTo(p,f+e),t.lineTo(p,s.b),t.stroke()}}}else for(let e=0,n=o.labelLine.spectrum.length;e<n;e++)if(""!==o.labelLine.spectrum[e].name&&o.labelLine.spectrum[e].lineStyle){let n=l.data[o.labelLine.spectrum[e].xAxis]*r+h,p=a.data[o.labelLine.spectrum[e].xAxis]*d+m;if(n>i.grid.left&&n<=s.r&&p>=i.grid.top&&p<=s.b){let l=o.labelLine.spectrum[e].name,r=o.labelLine.spectrum[e].lineStyle.color;t.beginPath(),t.lineWidth=1,t.strokeStyle=r,t.fillStyle=r,t.fillStyle=r,t.font=a.fontStyle.size+" "+a.fontStyle.family,t.save(),t.moveTo(n,i.grid.top),t.lineTo(n,s.b),t.translate(n-s.h,110+i.grid.top),t.rotate(-90*Math.PI/180),t.textAlign="right",t.textBaseline="bottom",t.fillText(l,40+i.grid.top,s.h),t.restore(),t.stroke()}}o.toolCheck=2},drawAddLabel:function(e=1){let t=this._flag,o=this._option,i=this._drawTools.ctx.foreground,l=t.addPeak.length,a={width:this._scope.v.x.end.toFixed(4).length>=8?120:110,height:40},s=~~(this._scope.r.w/(a.width+10)),n=o.x.data,r=(o.y.data,n[n.length-1]);if(1===e&&l<s){if(0!==l){for(let e=0;e<l;e++)if(t.addPeak[e]===t.line.key)return;t.addPeak.push(t.line.key),l++}else{if(l===s)return;t.addPeak.push(t.line.key),l++}t.addPeak.sort((e,t)=>e-t),t.addPeakPos.length=0;for(let e=0;e<l;e++)t.addPeakPos.push({xName:o.x.name,freq:o.x.data[t.addPeak[e]],x:e*(a.width+5)+o.grid.left+.5,y:o.grid.top,flag:0})}else if(2===e){let e=null,o=null,i=-1;for(let a=0;a<l;a++)if(t.addPeakPos[a].flag){o=t.addPeak[a],e=t.addPeakPos[a],i=a,t.addPeak.splice(a,1),t.addPeakPos.splice(a,1);break}i>-1&&(t.addPeak.push(o),t.addPeakPos.push(e))}if(o.series.dataMsg.setPower&&o.x.name===t.addPeakPos[0].xName)for(let e=0,o=n.length;e<o;e++)for(let o=0,i=t.addPeakPos.length;o<i;o++)if(t.addPeakPos[o].freq==n[e]){t.addPeak[o]=e;break}i.clearRect(0,0,this._dom.width,this._dom.height),i.beginPath(),i.font=o.series.markLine.fontStyle.size+" "+o.series.markLine.fontStyle.family,i.textBaseline="top",i.strokeStyle=o.series.markLine.lineStyle.color;let h,d={x:null,y:null};switch(o.x.name){case"Hz":h="频率：";break;case"NX":h="倍频："}for(let e=0;e<l;e++){if(o.x.data.length<t.addPeak[e]&&o.series.dataMsg.setPower||t.addPeakPos[e].freq>r&&t.addPeakPos.xName===o.x.name)continue;let l=t.addPeakPos[e].x+a.width/2;d={x:o.x.data[t.addPeak[e]]*this._computeParams.proportion.x.k+this._computeParams.proportion.x.b,y:o.y.data[t.addPeak[e]]*this._computeParams.proportion.y.k+this._computeParams.proportion.y.b},i.fillStyle=o.series.markLine.lineStyle.color,i.fillRect(t.addPeakPos[e].x,t.addPeakPos[e].y,a.width,a.height),i.fillStyle=o.series.markLine.fontStyle.color,i.fillText(h+o.x.data[t.addPeak[e]]+o.x.name,t.addPeakPos[e].x+5,t.addPeakPos[e].y+8),i.fillText("幅值："+o.y.data[t.addPeak[e]].toFixed(4)+o.y.name,t.addPeakPos[e].x+5,t.addPeakPos[e].y+23),i.moveTo(l,t.addPeakPos[e].y+a.height),i.lineTo(d.x,d.y)}if(i.stroke(),o.toolTip.symbol.show){i.strokeStyle=o.toolTip.lineStyle.color,i.fillStyle=""!==o.toolTip.symbol.color?o.toolTip.symbol.color:o.toolTip.lineStyle.color;for(let e=0;e<l;e++)i.beginPath(),d={x:o.x.data[t.addPeak[e]]*this._computeParams.proportion.x.k+this._computeParams.proportion.x.b,y:o.y.data[t.addPeak[e]]*this._computeParams.proportion.y.k+this._computeParams.proportion.y.b},i.arc(d.x,d.y,o.toolTip.symbol.size,0,2*Math.PI),i.fill()}i.clearRect(0,0,this._dom.width,o.grid.top),i.clearRect(0,o.grid.top,o.grid.left,this._dom.height-o.grid.top),i.clearRect(o.grid.left,this._scope.r.b,this._dom.width-o.grid.left,o.grid.bottom),i.clearRect(this._scope.r.r,o.grid.top,o.grid.right,this._scope.r.h)},getPeakIndexArr:function(e,t){if(e.length<=1)return[0];var o=[],i=[],l=0,a=0,s=e.length,n={};for(e[0]>e[1]&&(n.key=0,n.value=e[0],i.push(n)),l=1;l<s-1;l++)e[l]>e[l-1]&&e[l]>e[l+1]&&(n={},n.key=l,n.value=e[l],i.push(n));for(e[s-2]<e[s-1]&&(n={},n.key=s-1,n.value=e[s-1],i.push(n)),s=i.length,l=0;l<t;l++)for(a=l+1;a<s;a++)i[l].value<i[a].value&&(n=i[l],i[l]=i[a],i[a]=n);for(t>s&&(t=s),l=0;l<t;l++)o.push(i[l].key);return o},funDownload:function(e,t){var o=document.createElement("a");o.download=t,o.style.display="none";var i=new Blob([e]);o.href=URL.createObjectURL(i),o.dispatchEvent(new MouseEvent("click"))},drawMarkLine:function(){let e=this._option,t=e.series.markLine.data,o=this._drawTools.ctx.failure,i=this._computeParams.proportion.x,l=this._computeParams.proportion.y,a=this._scope.r;e.x.data[e.x.data.length-1],e.x.data[0];if(o.clearRect(0,0,this._dom.width,this._dom.height),t&&t.length>0){let s=e.series.markLine.lineStyle,n=e.series.markLine.fontStyle;for(let r=0,h=t.length;r<h;r++){let h=e.x.data[t[r].xAxis]*i.k+i.b+.5,d=e.y.data[t[r].xAxis]*l.k+l.y.b;h>=e.grid.left&&h<=a.r&&d>=e.grid.top&&d<=a.b&&(o.beginPath(),o.lineWidth=1,o.strokeStyle=s.color,o.fillStyle=n.color,o.font=n.weight+" "+n.size+" "+n.family,o.save(),o.moveTo(h,e.grid.top),o.lineTo(h,d-3),o.translate(h-a.h,110+e.grid.top),o.rotate(-90*Math.PI/180),o.textAlign="right",o.textBaseline="bottom",o.fillText(t[r].name,40+e.grid.top,a.h),o.restore(),o.stroke(),o.beginPath(),o.fillStyle=s.color,o.arc(h,d,3,0,2*Math.PI),o.fill(),o.moveTo(h,d+3),o.lineTo(h,a.b),o.stroke())}}}},new o(e)};return t.init=e,t});